kibana.doc

[TOC]
### 1.安装
官方地址：<https://www.elastic.co/downloads/past-releases>，下载对应版本即可，这里选择Linux 64位tar包，路径`/data/app/kibana`
### 2.配置文件
config/kibana.yml
```
# ====== 监听端口这个版本不能修改为80，其他版本未验测 ======
server.port: 5601 
# ====== 监听地址 ======
server.host: "yzh-ks-prod-kibana1" 
# ====== kibana web展示名 ======
server.name: "yzh-ops-efk-kibana"
kibana.index: ".kibana"
kibana.defaultAppId: "home"
# ====== 输出源es配置 ======
elasticsearch.preserveHost: true # true: 使用配置文件中server.host,false: 使用kibana主机的hostname
elasticsearch.url: "http://localhost:29200"
elasticsearch.username: "elastic"
elasticsearch.password: "E1astIc@o4l6%0ps"
elasticsearch.ssl.certificate: /data/app/kibana/config/certs/efk-es.cloudwise.com.crt
elasticsearch.ssl.key: /data/app/kibana/config/certs/efk-es.cloudwise.com.key
elasticsearch.ssl.certificateAuthorities: [ "/data/app/kibana/config/certs/ca.crt" ]
elasticsearch.ssl.verificationMode: certificate
```
### 3.启动脚本
centos 6.x: /etc/init.d/kibana
```
#!/bin/sh
# Init script for kibana
# Maintained by
# Generated by pleaserun.
# Implemented based on LSB Core 3.1:
#   * Sections: 20.2, 20.3
#
### BEGIN INIT INFO
# Provides:          kibana
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description:
# Description:       Kibana
### END INIT INFO

PATH=/sbin:/usr/sbin:/bin:/usr/bin
export PATH

name=kibana
program=/data/app/kibana/bin/kibana
args=-c\\\ /data/app/kibana/config/kibana.yml
pidfile="/data/pid/${name}.pid"
logdir=/data/logs/kibana


[ -r /etc/default/$name ] && . /etc/default/$name
[ -r /etc/sysconfig/$name ] && . /etc/sysconfig/$name

user="${user:-kibana}"
group="${group:-kibana}"
chroot="/"
chdir="/"
nice=""

[ -z "$nice" ] && nice=0

trace() {
  logger -t "/etc/init.d/kibana" "$@"
}

emit() {
  trace "$@"
  echo "$@"
}

start() {
  # Ensure the log directory is setup correctly.
  [ ! -d "$logdir" ] && mkdir "$logdir"
  chown "$user":"$group" "$logdir"
  chmod 755 "$logdir"

  # Setup any environmental stuff beforehand
  # Run the program!
  chroot --userspec "$user":"$group" "$chroot" sh -c "
    cd \"$chdir\"
    exec \"$program\" $args
  " >> $logdir/kibana.stdout 2>> $logdir/kibana.stderr &

  # Generate the pidfile from here. If we instead made the forked process
  # generate it there will be a race condition between the pidfile writing
  # and a process possibly asking for status.
  echo $! > $pidfile

  emit "$name started"
  return 0
}

stop() {
  # Try a few times to kill TERM the program
  if status ; then
    pid=$(cat "$pidfile")
    trace "Killing $name (pid $pid) with SIGTERM"
    kill -TERM $pid
    # Wait for it to exit.
    for i in 1 2 3 4 5 ; do
      trace "Waiting $name (pid $pid) to die..."
      status || break
      sleep 1
    done
    if status ; then
      if [ "$KILL_ON_STOP_TIMEOUT" -eq 1 ] ; then
        trace "Timeout reached. Killing $name (pid $pid) with SIGKILL.  This may result in data loss."
        kill -KILL $pid
        emit "$name killed with SIGKILL."
      else
        emit "$name stop failed; still running."
      fi
    else
      emit "$name stopped."
    fi
  fi
}

status() {
  if [ -f "$pidfile" ] ; then
    pid=$(cat "$pidfile")
    if ps -p $pid > /dev/null 2> /dev/null ; then
      # process by this pid is running.
      # It may not be our pid, but that's what you get with just pidfiles.
      # TODO(sissel): Check if this process seems to be the same as the one we
      # expect. It'd be nice to use flock here, but flock uses fork, not exec,
      # so it makes it quite awkward to use in this case.
      return 0
    else
      return 2 # program is dead but pid file exists
    fi
  else
    return 3 # program is not running
  fi
}

force_stop() {
  if status ; then
    stop
    status && kill -KILL $(cat "$pidfile")
  fi
}
case "$1" in
  force-start|start|stop|force-stop|restart)
    trace "Attempting '$1' on kibana"
    ;;
esac

case "$1" in
  force-start)
    PRESTART=no
    exec "$0" start
    ;;
  start)
    status
    code=$?
    if [ $code -eq 0 ]; then
      emit "$name is already running"
      exit $code
    else
      start
      exit $?
    fi
    ;;
  stop) stop ;;
  force-stop) force_stop ;;
  status)
    status
    code=$?
    if [ $code -eq 0 ] ; then
      emit "$name is running"
    else
      emit "$name is not running"
    fi
    exit $code
    ;;
  restart)

    stop && start
    ;;
  *)
    echo "Usage: $SCRIPTNAME {start|force-start|stop|force-start|force-stop|status|restart}" >&2
    exit 3
  ;;
esac
exit $?
```
centos 7.x: 
```
[Unit]
Description=Kibana
[Service]
Type=simple
User=kibana
Group=kibana
# Load env vars from /etc/default/ and /etc/sysconfig/ if they exist.
# Prefixing the path with '-' makes it try to load, but if the file doesn't
# exist, it continues onward.
EnvironmentFile=-/etc/default/kibana
EnvironmentFile=-/etc/sysconfig/kibana
ExecStart=/data/app/kibana/bin/kibana "-c /data/app/kibana/config/kibana.yml"
Restart=always
WorkingDirectory=/

[Install]
WantedBy=multi-user.target
```
/etc/default/kibana
```
user="kibana"
group="kibana"
chroot="/"
chdir="/"
nice=""

# If this is set to 1, then when `stop` is called, if the process has
# not exited within a reasonable time, SIGKILL will be sent next.
# The default behavior is to simply log a message "program stop failed; still running"
KILL_ON_STOP_TIMEOUT=0
```
### 4.图表
#### 4.1 discover
4.1.1 搜索数据  
[Lucene查询语法](https://www.elastic.co/guide/en/kibana/6.3/lucene-query.html)
* 自由匹配
* 字段特定值，如status:200
* 范围系列值，如status:[400 TO 499]
* 多条件，布尔值关键字 AND,OR,NOT,如status:[400 TO 499] AND (extension:php OR extension:html)
* [Lucene更多语法](https://www.elastic.co/guide/en/elasticsearch/reference/6.3/query-dsl-query-string-query.html#query-string-syntax)

[查询语言增强功能](https://www.elastic.co/guide/en/kibana/6.3/kuery-query.html)(6.3版本为实验功能)  
4.1.2 查看文档上下文
![-w865](media/15408892866402/15408935459972.jpg)
更改上下文大小
要增加比锚文档更新的显示文档数，请单击文档列表上方的“Load 5 more”按钮，或在按钮右侧的输入框中输入所需的数字。
![-w474](media/15408892866402/15408936834695.jpg)

要增加比锚文档旧的显示文档数，请单击文档列表下方的“Load 5 more”按钮，或在按钮右侧的输入框中输入所需的数字。
![-w461](media/15408892866402/15408937024816.jpg)
#### 4.2 visualize
[visualize](https://www.elastic.co/guide/en/kibana/6.3/visualize.html)
#### 4.3 Timelion
[Timelion](https://www.elastic.co/guide/en/kibana/6.3/timelion-getting-started.html)

### 5. 官网建议生产环境
官网地址：<https://www.elastic.co/guide/en/kibana/current/production.html>  
* 启用x-pack认证    
* 启用SSL  
[Encrypting communications in Kibana](https://www.elastic.co/guide/en/kibana/current/configuring-tls.html)
* es集群节点负载均衡  
配置kibana连接es节点为协同节点：

```
node.master: false
node.data: false
node.ingest: false
```
